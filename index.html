<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Discount Calculator</title>
    <meta name="apple-mobile-web-app-title" content="Discount Calc">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="theme-color" content="#fbbf24">
    <meta name="description" content="A secure, accessible offline discount calculator.">

    <style>
        :root {
            --bg-body: #121e25;
            --bg-card: #1e2a32;
            --bg-keypad-btn: #28333e;
            
            --hero-bg: #fbbf24;
            --hero-text: #1a1a1a;
            
            --text-main: #ffffff;
            --text-muted: #8498a3;
            --accent: #53d0ec;
            --success: #34d399; /* Green */
            
            --radius: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- 1. HERO SECTION --- */
        .hero-section {
            background-color: var(--hero-bg);
            color: var(--hero-text);
            flex: 0 0 35%; /* Slightly taller for better proportion */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-bottom-left-radius: 32px;
            border-bottom-right-radius: 32px;
            padding: env(safe-area-inset-top) 1rem 1rem 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .hero-section:active { filter: brightness(0.95); }

        .reset-btn {
            position: absolute;
            top: calc(env(safe-area-inset-top) + 1rem);
            right: 1.5rem;
            background: rgba(0,0,0,0.1);
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .reset-btn:active { background: rgba(0,0,0,0.2); transform: rotate(-15deg); }
        .reset-btn svg { width: 22px; height: 22px; fill: var(--hero-text); }

        .hero-label {
            font-size: 0.9rem; font-weight: 600; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
        }

        .hero-total {
            font-size: 4rem; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; margin-bottom: 0.8rem;
            transition: transform 0.1s;
        }
        .bump { transform: scale(1.05); }

        /* UPDATED: Green Pill Badge */
        .hero-badge {
            background-color: var(--success); /* Green Background */
            color: #064e3b; /* Dark Green text for contrast */
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: 700; 
            font-size: 1.1rem; 
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* --- 2. INPUT LIST --- */
        .input-list {
            flex: 1; padding: 1.5rem 1rem; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto;
        }

        .row-card {
            background-color: var(--bg-card); border-radius: 16px; padding: 0 1.2rem; height: 80px; display: flex; align-items: center; justify-content: space-between; border: 2px solid transparent; transition: all 0.2s; cursor: pointer;
        }
        .row-card.active { border-color: var(--accent); background-color: #23303a; }

        .row-label { color: var(--text-muted); font-size: 0.95rem; font-weight: 600; z-index: 2; pointer-events: none; }

        .row-value {
            font-size: 1.8rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 4px; z-index: 2; pointer-events: none;
        }
        .row-symbol { font-size: 1.1rem; color: var(--text-muted); }
        .accent-text { color: var(--accent); }

        /* UPDATED: Slider Visuals */
        .row-card.interactive { position: relative; overflow: hidden; touch-action: none; }
        
        /* The Fill Bar (The colorful part) */
        .fill-bar {
            position: absolute; left: 0; top: 0; bottom: 0; width: 0%; 
            background: rgba(83, 208, 236, 0.25); /* Stronger visibility */
            z-index: 0; pointer-events: none;
            border-right: 2px solid var(--accent); /* The "Knob" line */
            box-shadow: 5px 0 20px rgba(83, 208, 236, 0.2); /* Glow */
            transition: width 0.05s linear;
        }

        /* Tax Disabled State */
        .row-card.disabled .fill-bar { display: none; }
        .row-card.disabled .row-value { opacity: 0.3; }
        .row-card.disabled .accent-text { color: var(--text-muted); }
        
        /* Tax Toggle Indicator */
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; margin-right: 8px;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .status-dot.on { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        /* --- 3. KEYPAD --- */
        .keypad {
            background-color: var(--bg-body); padding: 0 1rem max(1rem, env(safe-area-inset-bottom)) 1rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; flex: 0 0 auto;
        }

        .key-btn {
            background-color: var(--bg-keypad-btn); border: none; border-radius: 12px; color: var(--text-main); font-size: 1.6rem; font-weight: 500; height: 60px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.1s;
        }
        .key-btn:active { background-color: #384550; }
        .key-back svg { width: 24px; height: 24px; fill: var(--text-main); }
        .key-00 { font-size: 1.3rem; font-weight: 600; letter-spacing: -1px; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: black; color: white; padding: 8px 16px; border-radius: 20px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        
        .support-btn {
            position: absolute; top: calc(env(safe-area-inset-top) + 1rem); left: 1.5rem; background: rgba(0,0,0,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; text-decoration: none;
        }
        .support-btn:active { background: rgba(0,0,0,0.2); transform: scale(0.95); }
        .support-btn svg { width: 20px; height: 20px; fill: var(--hero-text); }
    </style>
</head>
<body>

    <div id="toast" class="toast">Copied!</div>

    <section class="hero-section" onclick="copyTotal()">
        
        <a href="https://www.buymeacoffee.com/YOUR_USERNAME" target="_blank" class="support-btn" aria-label="Support" onclick="event.stopPropagation()">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        </a>

        <button class="reset-btn" onclick="resetApp(event)" aria-label="Reset">
            <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </button>

        <div class="hero-label">Total Pay</div>
        <div class="hero-total" id="disp-total">0.00</div>
        
        <div class="hero-badge">
            <span>You Save</span>
            <span id="disp-saved">$0.00</span>
        </div>
    </section>

    <section class="input-list">
        
        <div id="card-price" class="row-card active" onclick="setFocus('price')">
            <span class="row-label">Original Price</span>
            <div class="row-value">
                <span class="row-symbol">$</span>
                <span id="disp-price">0.00</span>
            </div>
        </div>

        <div id="card-discount" class="row-card interactive" onclick="setFocus('discount')">
            <div class="fill-bar" id="fill-discount"></div>
            
            <span class="row-label">Discount</span>
            <div class="row-value accent-text">
                <span id="disp-discount">0</span>
                <span class="row-symbol">%</span>
            </div>
        </div>

        <div id="card-tax" class="row-card interactive disabled" onclick="toggleTax(event)">
            <div class="fill-bar" id="fill-tax"></div>
            
            <div style="display:flex; align-items:center; z-index:2">
                <span id="tax-dot" class="status-dot"></span>
                <span class="row-label">Tax</span>
            </div>
            
            <div class="row-value accent-text">
                <span id="disp-tax">7</span>
                <span class="row-symbol">%</span>
            </div>
        </div>

    </section>

    <section class="keypad">
        <button class="key-btn" onclick="pressKey('7')">7</button>
        <button class="key-btn" onclick="pressKey('8')">8</button>
        <button class="key-btn" onclick="pressKey('9')">9</button>
        <button class="key-btn" onclick="pressKey('4')">4</button>
        <button class="key-btn" onclick="pressKey('5')">5</button>
        <button class="key-btn" onclick="pressKey('6')">6</button>
        <button class="key-btn" onclick="pressKey('1')">1</button>
        <button class="key-btn" onclick="pressKey('2')">2</button>
        <button class="key-btn" onclick="pressKey('3')">3</button>
        <button class="key-btn key-00" onclick="pressKey('00')">00</button>
        <button class="key-btn" onclick="pressKey('0')">0</button>
        <button class="key-btn key-back" onclick="pressKey('BACK')">
            <svg viewBox="0 0 24 24"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.88 1.59.88h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/></svg>
        </button>
    </section>

<script>
    // --- STATE ---
    let activeField = 'price';
    let savedTaxRate = localStorage.getItem('taxRate') || "7";
    let savedTaxEnabled = localStorage.getItem('taxEnabled') === 'true';

    let state = { price: "", discount: "0", tax: savedTaxRate };
    let taxEnabled = savedTaxEnabled;

    // --- ELEMENTS ---
    const els = {
        priceCard: document.getElementById('card-price'),
        discCard: document.getElementById('card-discount'),
        taxCard: document.getElementById('card-tax'),
        taxDot: document.getElementById('tax-dot'),
        
        price: document.getElementById('disp-price'),
        discount: document.getElementById('disp-discount'),
        tax: document.getElementById('disp-tax'),
        saved: document.getElementById('disp-saved'),
        total: document.getElementById('disp-total'),
        
        fillDisc: document.getElementById('fill-discount'),
        fillTax: document.getElementById('fill-tax'),
        toast: document.getElementById('toast')
    };

    function vibrate() { if (navigator.vibrate) navigator.vibrate(10); }

    function saveSettings() {
        localStorage.setItem('taxRate', state.tax);
        localStorage.setItem('taxEnabled', taxEnabled);
    }

    // --- FOCUS & TOGGLE LOGIC ---
    function setFocus(field) {
        vibrate();
        activeField = field;
        
        // Visual Focus states
        els.priceCard.classList.toggle('active', field === 'price');
        els.discCard.classList.toggle('active', field === 'discount');
        
        // Tax is special: we show it active if we are editing it, OR if it is enabled
        if (field === 'tax') {
            els.taxCard.classList.add('active');
        } else {
            els.taxCard.classList.remove('active');
        }
    }

    function toggleTax(e) {
        // If clicking slider but not dragging, toggle.
        // If dragging, we handle that in scrubber.
        // For simplicity: If disabled, enable and focus. If enabled, just focus.
        // To disable: We can't easily "tap to disable" if tap also focuses.
        // Let's make it: Tap to Focus. Double Tap (or separate logic) to toggle?
        // Simpler approach matching screenshot: Use the 'dot' to show status.
        
        // Logic: If I tap the card, I want to edit tax.
        // If it was disabled, enable it automatically.
        if (!taxEnabled) {
            taxEnabled = true;
            saveSettings();
        }
        setFocus('tax');
        updateUI();
    }

    // --- KEYPAD ---
    function pressKey(key) {
        vibrate();
        let currentVal = state[activeField];

        if (key === 'BACK') {
            state[activeField] = currentVal.slice(0, -1);
            if (state[activeField] === "" && activeField !== 'price') state[activeField] = "0";
        } 
        else if (key === '00') {
            if (activeField === 'price') {
                if (currentVal.length < 8) state.price += "00";
            } else {
                if (currentVal === "0" || currentVal === "") state[activeField] = "0"; 
                else {
                    let nextVal = currentVal + "00";
                    if (parseInt(nextVal) <= 100) state[activeField] = nextVal;
                }
            }
        }
        else {
            if (activeField === 'price') {
                if (currentVal.length < 9) state.price += key;
            } else {
                let nextVal = (currentVal === "0" ? "" : currentVal) + key;
                if (parseInt(nextVal) <= 100) state[activeField] = nextVal;
            }
        }
        
        if (activeField === 'tax') saveSettings();
        updateUI();
        
        // Bump Animation
        els.total.classList.remove('bump');
        void els.total.offsetWidth;
        els.total.classList.add('bump');
    }

    function updateUI() {
        let p = state.price ? parseInt(state.price) / 100 : 0;
        let d = parseInt(state.discount) || 0;
        let t = parseInt(state.tax) || 0;

        let saved = p * (d / 100);
        let subtotal = p - saved;
        
        let taxAmt = 0;
        // Update Tax Visuals
        if (taxEnabled) {
            taxAmt = subtotal * (t / 100);
            els.taxCard.classList.remove('disabled');
            els.taxDot.classList.add('on');
        } else {
            els.taxCard.classList.add('disabled');
            els.taxDot.classList.remove('on');
        }

        let total = subtotal + taxAmt;

        const fmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        els.price.textContent = fmt.format(p);
        els.discount.textContent = d;
        els.tax.textContent = t;
        els.saved.textContent = "$" + fmt.format(saved);
        els.total.textContent = fmt.format(total);

        els.fillDisc.style.width = d + '%';
        els.fillTax.style.width = t + '%';
    }

    // --- SCRUBBER LOGIC ---
    function setupScrubber(element, field) {
        let startX = 0; let startVal = 0; let isDragging = false;
        
        // Long press or quick tap logic for disabling tax?
        // Let's stick to standard slide
        
        element.addEventListener('touchstart', (e) => {
            // Auto-enable tax on touch
            if (field === 'tax' && !taxEnabled) {
                taxEnabled = true;
                saveSettings();
                updateUI();
            }

            setFocus(field);
            startX = e.touches[0].clientX;
            startVal = parseInt(state[field]) || 0;
            isDragging = false;
        }, { passive: false });

        element.addEventListener('touchmove', (e) => {
            const currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;
            if (Math.abs(deltaX) > 5) isDragging = true;
            if (isDragging) {
                e.preventDefault();
                let change = Math.round(deltaX / 3); // Slightly slower sensitivity
                let newVal = startVal + change;
                if (newVal < 0) newVal = 0; if (newVal > 100) newVal = 100;
                
                state[field] = newVal.toString();
                if (field === 'tax') saveSettings();
                updateUI();
            }
        }, { passive: false });
        
        // Double tap to disable tax?
        if (field === 'tax') {
            let lastTap = 0;
            element.addEventListener('touchend', (e) => {
                if (isDragging) return; // Ignore drags
                let currentTime = new Date().getTime();
                let tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    // Double Tap detected
                    taxEnabled = !taxEnabled;
                    saveSettings();
                    updateUI();
                    e.preventDefault();
                }
                lastTap = currentTime;
            });
        }
    }

    setupScrubber(els.discCard, 'discount');
    setupScrubber(els.taxCard, 'tax');

    function resetApp(e) {
        e.stopPropagation();
        vibrate();
        state.price = "";
        state.discount = "0";
        setFocus('price');
        updateUI();
    }

    function copyTotal() {
        vibrate();
        if (navigator.clipboard) {
            navigator.clipboard.writeText(els.total.textContent);
            els.toast.style.opacity = '1';
            setTimeout(() => els.toast.style.opacity = '0', 2000);
        }
    }
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
    }
    
    updateUI();
</script>
</body>
</html>
