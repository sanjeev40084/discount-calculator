<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Discount Calculator</title>
    <meta name="apple-mobile-web-app-title" content="Discount Calc">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="theme-color" content="#121e25">
    <meta name="description" content="A secure, accessible offline discount calculator.">

    <style>
        :root {
            --bg-body: #121e25;
            --bg-hero: #004b49;
            --bg-card: #28333e;
            --bg-keypad-btn: #1e2a32;
            --text-main: #ffffff;
            --text-muted: #8498a3;
            --accent: #53d0ec;
            --accent-fill: rgba(83, 208, 236, 0.15); /* Background fill for sliders */
            --focus-border: 2px solid #53d0ec;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom) 1rem;
            user-select: none; /* Prevent text selection during sliding */
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 450px;
            margin: 0 auto;
            width: 100%;
            gap: 1rem;
            padding-top: 1rem;
        }

        /* --- 1. HERO SECTION (Price) --- */
        .hero-card {
            background-color: var(--bg-hero);
            border-radius: var(--radius);
            flex: 0 0 auto;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 2px solid transparent; /* Reserve space for focus border */
            transition: border-color 0.2s;
            cursor: pointer;
        }
        
        .hero-card.active { border: var(--focus-border); }

        .hero-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: #ffffff;
            font-variant-numeric: tabular-nums;
        }

        /* --- 2. INFO GRID --- */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            flex: 0 0 auto;
        }

        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            height: 120px; /* Fixed height for consistent touch targets */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden; /* Contains the fill bar */
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .card.interactive { cursor: ew-resize; touch-action: none; /* Prevents scroll while dragging */ }
        .card.active { border: var(--focus-border); }

        /* The Liquid Fill Background */
        .fill-bar {
            position: absolute;
            left: 0; bottom: 0; top: 0;
            width: 0%; /* JS will update this */
            background-color: var(--accent-fill);
            z-index: 0;
            pointer-events: none;
            transition: width 0.05s linear; /* Smooth visual update */
        }

        .card-content {
            position: relative;
            z-index: 1; /* Sits on top of fill bar */
            pointer-events: none; /* Let clicks pass through to the card container */
        }

        .card label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            display: block;
        }

        .card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            font-variant-numeric: tabular-nums;
        }
        
        /* Large Number Display for Discount/Tax */
        .big-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
        }
        .percent-symbol {
            font-size: 1.2rem;
            color: var(--text-muted);
            vertical-align: super;
        }

        .result-text { color: var(--text-main); }
        .accent-text { color: var(--accent); }

        /* Mini Toggle Switch for Tax */
        .mini-switch-wrapper {
            position: absolute;
            top: 10px; right: 10px;
            z-index: 2; /* Clickable */
        }
        .mini-switch {
            position: relative; display: block;
            width: 24px; height: 14px;
        }
        .mini-switch input { opacity: 0; width: 0; height: 0; }
        .mini-slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #4a555e;
            border-radius: 34px; transition: .4s;
        }
        .mini-slider:before {
            position: absolute; content: "";
            height: 10px; width: 10px;
            left: 2px; bottom: 2px;
            background-color: white;
            border-radius: 50%; transition: .4s;
        }
        input:checked + .mini-slider { background-color: var(--accent); }
        input:checked + .mini-slider:before { transform: translateX(10px); }

        /* --- 3. KEYPAD --- */
        .keypad {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-top: auto;
            padding-bottom: 1rem;
        }

        .key-btn {
            background-color: var(--bg-keypad-btn);
            border: none;
            border-radius: 12px;
            color: var(--text-main);
            font-size: 1.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.1s;
        }
        .key-btn:active { background-color: #384550; }
        .key-ac { color: #ff6b6b; font-size: 1.4rem; font-weight: 700; }
        .key-back svg { width: 28px; height: 28px; fill: var(--text-main); }

        /* Toast for Copy */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: #000; font-weight: 700;
            padding: 8px 16px; border-radius: 20px; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
    </style>
</head>
<body>

<main class="app-container">

    <div id="toast" class="toast">Copied!</div>

    <section id="card-price" class="hero-card active" onclick="setFocus('price')" role="button" aria-label="Bill Total">
        <div class="hero-label">Bill Total</div>
        <div class="hero-value" id="disp-price">0.00</div>
    </section>

    <section class="info-grid">
        
        <div id="card-discount" class="card interactive" onclick="setFocus('discount')" role="slider" aria-label="Discount Percentage">
            <div class="fill-bar" id="fill-discount"></div>
            <div class="card-content">
                <label>Discount</label>
                <div class="big-number">
                    <span id="disp-discount">0</span><span class="percent-symbol">%</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-content">
                <label>You Save</label>
                <div class="card-value accent-text" id="disp-saved">0.00</div>
            </div>
        </div>

        <div id="card-tax" class="card interactive" onclick="setFocus('tax')" role="slider" aria-label="Tax Rate">
            <div class="fill-bar" id="fill-tax"></div>
            
            <div class="mini-switch-wrapper" onclick="event.stopPropagation()">
                <label class="mini-switch">
                    <input type="checkbox" id="tax-toggle">
                    <span class="mini-slider"></span>
                </label>
            </div>

            <div class="card-content" id="tax-content" style="opacity: 0.3;">
                <label>Tax</label>
                <div class="big-number">
                    <span id="disp-tax">7</span><span class="percent-symbol">%</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="copyTotal()" style="cursor: pointer">
            <div class="card-content">
                <label>Total</label>
                <div class="card-value result-text" id="disp-total">0.00</div>
            </div>
        </div>

    </section>

    <section class="keypad">
        <button class="key-btn" onclick="pressKey('7')">7</button>
        <button class="key-btn" onclick="pressKey('8')">8</button>
        <button class="key-btn" onclick="pressKey('9')">9</button>
        <button class="key-btn" onclick="pressKey('4')">4</button>
        <button class="key-btn" onclick="pressKey('5')">5</button>
        <button class="key-btn" onclick="pressKey('6')">6</button>
        <button class="key-btn" onclick="pressKey('1')">1</button>
        <button class="key-btn" onclick="pressKey('2')">2</button>
        <button class="key-btn" onclick="pressKey('3')">3</button>
        <button class="key-btn key-ac" onclick="pressKey('AC')">AC</button>
        <button class="key-btn" onclick="pressKey('0')">0</button>
        <button class="key-btn key-back" onclick="pressKey('BACK')">
            <svg viewBox="0 0 24 24"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.88 1.59.88h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/></svg>
        </button>
    </section>

</main>

<script>
    // --- STATE ---
    // 'price', 'discount', or 'tax'
    let activeField = 'price'; 
    
    // Data values (Strings to handle keypad typing easily)
    let state = {
        price: "",       // "1250" -> 12.50
        discount: "0",   // "25" -> 25%
        tax: "7"         // "7" -> 7%
    };

    // --- ELEMENTS ---
    const els = {
        priceCard: document.getElementById('card-price'),
        discCard: document.getElementById('card-discount'),
        taxCard: document.getElementById('card-tax'),
        
        price: document.getElementById('disp-price'),
        discount: document.getElementById('disp-discount'),
        tax: document.getElementById('disp-tax'),
        saved: document.getElementById('disp-saved'),
        total: document.getElementById('disp-total'),
        
        fillDisc: document.getElementById('fill-discount'),
        fillTax: document.getElementById('fill-tax'),
        
        taxToggle: document.getElementById('tax-toggle'),
        taxContent: document.getElementById('tax-content'),
        toast: document.getElementById('toast')
    };

    // --- FOCUS LOGIC ---
    function setFocus(field) {
        activeField = field;
        
        // Update Visuals (Border highlight)
        els.priceCard.classList.toggle('active', field === 'price');
        els.discCard.classList.toggle('active', field === 'discount');
        els.taxCard.classList.toggle('active', field === 'tax');

        // If switching to Price, don't clear. If switching to Disc/Tax, 
        // we might want to overwrite if user types immediately? 
        // For now, standard behavior: just append.
    }

    // --- KEYPAD LOGIC ---
    function pressKey(key) {
        let currentVal = state[activeField];

        if (key === 'AC') {
            state[activeField] = "";
            if (activeField === 'discount' || activeField === 'tax') state[activeField] = "0";
        } else if (key === 'BACK') {
            state[activeField] = currentVal.slice(0, -1);
            if (state[activeField] === "" && activeField !== 'price') state[activeField] = "0";
        } else {
            // Typing Numbers
            if (activeField === 'price') {
                if (currentVal.length < 9) state.price += key;
            } else {
                // Discount/Tax (Limit to 100)
                let nextVal = (currentVal === "0" ? "" : currentVal) + key;
                if (parseInt(nextVal) <= 100) state[activeField] = nextVal;
            }
        }
        updateUI();
    }

    // --- CALCULATION & RENDER ---
    function updateUI() {
        // Parse Values
        let p = state.price ? parseInt(state.price) / 100 : 0;
        let d = parseInt(state.discount) || 0;
        let t = parseInt(state.tax) || 0;

        // Math
        let saved = p * (d / 100);
        let subtotal = p - saved;
        
        let taxAmt = 0;
        let taxOn = els.taxToggle.checked;
        if (taxOn) {
            taxAmt = subtotal * (t / 100);
            els.taxContent.style.opacity = '1';
        } else {
            els.taxContent.style.opacity = '0.3';
        }

        let total = subtotal + taxAmt;

        // Render Text
        const fmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        els.price.textContent = fmt.format(p);
        els.discount.textContent = d;
        els.tax.textContent = t;
        els.saved.textContent = fmt.format(saved);
        els.total.textContent = fmt.format(total);

        // Render Fill Bars
        els.fillDisc.style.width = d + '%';
        els.fillTax.style.width = t + '%';
    }

    // --- SCRUBBING (TOUCH SLIDER) LOGIC ---
    function setupScrubber(element, field) {
        let startX = 0;
        let startVal = 0;
        let isDragging = false;

        // Touch Start
        element.addEventListener('touchstart', (e) => {
            // If tapping the mini-toggle, ignore
            if(e.target.closest('.mini-switch-wrapper')) return;

            setFocus(field); // Activate card
            startX = e.touches[0].clientX;
            startVal = parseInt(state[field]) || 0;
            isDragging = false;
        }, { passive: false });

        // Touch Move
        element.addEventListener('touchmove', (e) => {
            const currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;

            // Threshold to start dragging (prevent accidental drags on taps)
            if (Math.abs(deltaX) > 5) isDragging = true;
            
            if (isDragging) {
                e.preventDefault(); // Stop scrolling
                
                // Sensitivity: 1% per 2 pixels
                let change = Math.round(deltaX / 2); 
                let newVal = startVal + change;

                // Clamping
                if (newVal < 0) newVal = 0;
                if (newVal > 100) newVal = 100;

                state[field] = newVal.toString();
                updateUI();
            }
        }, { passive: false });
    }

    // Initialize Scrubbers
    setupScrubber(els.discCard, 'discount');
    setupScrubber(els.taxCard, 'tax');

    // --- EXTRAS ---
    els.taxToggle.addEventListener('change', updateUI);

    function copyTotal() {
        const text = els.total.textContent;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
            els.toast.style.opacity = '1';
            setTimeout(() => els.toast.style.opacity = '0', 2000);
        }
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
    }

    // Init
    updateUI();

</script>

</body>
</html>
